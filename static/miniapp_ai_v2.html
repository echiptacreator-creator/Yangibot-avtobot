const tg = window.Telegram.WebApp;
tg.expand();

const state = {
  toggles: {}
};

// --------------------
// INIT
// --------------------
document.addEventListener("DOMContentLoaded", () => {
  initRegions();
  initCars();
  initToggles();
});

// --------------------
// REGIONS + DISTRICTS
// --------------------
function initRegions() {
  const from = document.getElementById("from_region");
  const to = document.getElementById("to_region");

  from.innerHTML = `<option value="">Qayerdan</option>`;
  to.innerHTML = `<option value="">Qayerga</option>`;

  Object.keys(REGIONS).forEach(r => {
    from.innerHTML += `<option>${r}</option>`;
    to.innerHTML += `<option>${r}</option>`;
  });
}

function addDistrict() {
  const container = document.getElementById("districts");
  const div = document.createElement("div");
  div.className = "row";
  div.style.marginTop = "8px";

  div.innerHTML = `
    <select class="district-from"></select>
    <select class="district-to"></select>
  `;

  container.appendChild(div);

  fillDistricts(div.querySelector(".district-from"), "from_region");
  fillDistricts(div.querySelector(".district-to"), "to_region");
}

function fillDistricts(select, regionId) {
  const region = document.getElementById(regionId).value;
  select.innerHTML = `<option value="">Tuman</option>`;
  if (!REGIONS[region]) return;
  REGIONS[region].forEach(d => {
    select.innerHTML += `<option>${d}</option>`;
  });
}

// --------------------
// CARS
// --------------------
function initCars() {
  const car = document.getElementById("car");
  car.innerHTML = `<option value="">Mashina tanlang</option>`;
  CARS.forEach(c => car.innerHTML += `<option>${c}</option>`);

  car.onchange = () => {
    document.getElementById("custom_car")
      .classList.toggle("hidden", car.value !== "Boshqa");
  };
}

// --------------------
// TOGGLES (TRUE/FALSE)
// --------------------
function initToggles() {
  document.querySelectorAll(".toggle").forEach(t => {
    const key = t.dataset.key;
    state.toggles[key] = false;

    t.onclick = () => {
      state.toggles[key] = !state.toggles[key];
      t.classList.toggle("active");
    };
  });
}

// --------------------
// SUBMIT
// --------------------
function submitForm() {
  const data = {
    from: document.getElementById("from_region").value,
    to: document.getElementById("to_region").value,
    people: document.getElementById("people").value,
    time: document.getElementById("time").value,
    car: getCar(),
    fuel: document.getElementById("fuel").value,
    phone: document.getElementById("phone").value,
    phone2: document.getElementById("phone2").value,
    comment: document.getElementById("comment").value,
    flags: state.toggles,
    districts: collectDistricts()
  };

  tg.sendData(JSON.stringify({
    action: "ai_post",
    payload: data
  }));

  tg.close();
}

function getCar() {
  const car = document.getElementById("car").value;
  if (car === "Boshqa") {
    return document.getElementById("custom_car").value;
  }
  return car;
}

function collectDistricts() {
  const result = [];
  document.querySelectorAll("#districts .row").forEach(r => {
    const f = r.querySelector(".district-from").value;
    const t = r.querySelector(".district-to").value;
    if (f || t) result.push({ from: f, to: t });
  });
  return result;
}