<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<title>Guruhlarni tanlash</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root {
  --blue:#2f80ff;
}
body {
  margin:0;
  font-family: system-ui,-apple-system;
  background:var(--tg-theme-bg-color);
  color:var(--tg-theme-text-color);
}
.wrap { padding:16px; padding-bottom:90px; }

h1 { margin:0 0 6px }
.sub { opacity:.7; margin-bottom:12px }

.search {
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid rgba(0,0,0,.1);
  margin-bottom:12px;
  font-size:15px;
}

.group {
  background:var(--tg-theme-secondary-bg-color);
  padding:12px;
  border-radius:12px;
  margin-bottom:10px;
  display:flex;
  align-items:center;
  gap:10px;
}

.group.saved {
  opacity:.5;
}

.group.selected {
  outline:2px solid var(--blue);
}

.group input { transform:scale(1.2) }

.action-bar {
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:var(--tg-theme-bg-color);
  border-top:1px solid rgba(0,0,0,.1);
  padding:12px;
}

button {
  width:100%;
  padding:14px;
  border:none;
  border-radius:14px;
  background:var(--blue);
  color:#fff;
  font-size:15px;
  font-weight:600;
}

.toast {
  position:fixed;
  bottom:100px;
  left:50%;
  transform:translateX(-50%);
  background:var(--blue);
  color:#fff;
  padding:10px 14px;
  border-radius:10px;
}
</style>
</head>

<body>
<div class="wrap">
  <h1>Guruhlar</h1>
  <div class="sub">Xabar yuborish uchun guruhlarni tanlang</div>

  <input
    class="search"
    placeholder="üîç Guruh nomi yoki @username"
    oninput="filterGroups(this.value)"
  >

  <div id="groups">‚è≥ Yuklanmoqda...</div>
</div>

<div class="action-bar">
  <button onclick="save()">‚ûï Tanlanganlarni qo‚Äòshish (<span id="count">0</span>)</button>
</div>

<script>
const tg = Telegram.WebApp;
tg.ready();

const userId = tg.initDataUnsafe.user.id;
let groups = [];
let selected = new Set();

function showToast(text){
  const t=document.createElement("div");
  t.className="toast";
  t.innerText=text;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),2500);
}

async function loadGroups(){
  const box=document.getElementById("groups");
  const res=await fetch(`/api/temp-groups?user_id=${userId}`);
  groups=await res.json();

  if(!groups.length){
    box.innerHTML="‚ùå Guruhlar topilmadi";
    return;
  }

  box.innerHTML="";
  groups.forEach(g=>{
    const div=document.createElement("div");
    div.className="group";
    div.dataset.search=(g.title+" "+(g.username||"")).toLowerCase();

    div.innerHTML=`
      <input type="checkbox" onchange="toggle(${g.group_id},this)">
      <div>
        <b>${g.title}</b><br>
        <small>${g.username? "@"+g.username : ""}</small>
      </div>
    `;
    box.appendChild(div);
  });
}

function toggle(id,el){
  const card=el.closest(".group");
  if(el.checked){
    selected.add(id);
    card.classList.add("selected");
  }else{
    selected.delete(id);
    card.classList.remove("selected");
  }
  document.getElementById("count").innerText=selected.size;
}

function filterGroups(q){
  q=q.toLowerCase();
  document.querySelectorAll(".group").forEach(el=>{
    el.style.display=el.dataset.search.includes(q)?"flex":"none";
  });
}

async function save(){
  if(!selected.size){
    tg.showPopup({message:"Hech narsa tanlanmadi"});
    return;
  }

  const payload=groups.filter(g=>selected.has(g.group_id));

  await fetch("/api/user-groups/bulk-add",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      user_id:userId,
      groups:payload
    })
  });

  showToast(`‚úÖ ${payload.length} ta guruh qo‚Äòshildi`);
  tg.showPopup({message:"‚úÖ Guruhlar muvaffaqiyatli qo‚Äòshildi"});
  selected.clear();
  document.getElementById("count").innerText=0;
}

loadGroups();
</script>
</body>
</html>
